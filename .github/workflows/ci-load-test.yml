name: CI - Load Test on Kubernetes

on:
  pull_request:
    branches:
      - main

jobs:
  load-test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup KinD cluster
        uses: helm/kind-action@v1.7.0
        with:
          cluster_name: load-test-cluster
          config: ./k8s/kind-config.yaml
      
      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Install Ingress controller
        run: |
          echo "Installing NGINX ingress controller..."
          kubectl apply -f ./k8s/ingress-nginx-controller.yaml
          
          echo "Waiting for controller pod to be ready. This may take 2-3 minutes..."
          kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=600s || (echo "Controller pod failed to start:" && kubectl describe pods -n ingress-nginx && kubectl logs -n ingress-nginx -l app.kubernetes.io/component=controller --tail=50 && exit 1)
      
      - name: Deploy foo and bar services
        run: |
          kubectl apply -f ./k8s/namespace.yaml
          kubectl apply -f ./k8s/foo-deployment.yaml
          kubectl apply -f ./k8s/bar-deployment.yaml
          kubectl apply -f ./k8s/ingress.yaml
          
          echo "Waiting for ingress to be created..."
          kubectl wait --for=condition=established ingress/app-ingress -n app --timeout=30s 2>/dev/null || true
          
          kubectl get ingress app-ingress -n app
          echo "Ingress configured successfully"
      
      - name: Wait for deployments to be ready
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/foo -n app
          kubectl wait --for=condition=available --timeout=300s deployment/bar -n app
          kubectl get deployment,pods,svc,ingress -n app
      
      - name: Setup local DNS resolution
        run: |
          echo "127.0.0.1 foo.localhost" | sudo tee -a /etc/hosts
          echo "127.0.0.1 bar.localhost" | sudo tee -a /etc/hosts
      
      - name: Port-forward Ingress
        run: |
          kubectl port-forward -n ingress-nginx svc/ingress-nginx-controller 8080:80 &
          echo "INGRESS_PID=$!" >> $GITHUB_ENV
          sleep 5
      
      - name: Health check
        run: |
          bash ./scripts/health-check.sh
      
      - name: Run load test
        run: |
          bash ./scripts/load-test.sh
        env:
          LOAD_TEST_DURATION: 60
          LOAD_TEST_CONCURRENCY: 10
      
      - name: Cleanup port-forward
        if: always()
        run: |
          if [ -n "$INGRESS_PID" ]; then
            kill $INGRESS_PID 2>/dev/null || true
          fi
      
      - name: Cleanup DNS entries
        if: always()
        run: |
          sudo sed -i '/foo.localhost/d' /etc/hosts
          sudo sed -i '/bar.localhost/d' /etc/hosts
      
      - name: Get load test results
        if: always()
        id: results
        run: |
          if [ -f load-test-results.json ]; then
            cat load-test-results.json > results.json
            cat load-test-results.txt
            
            {
              echo 'comment<<EOF'
              jq -r '
                "Load Test Results\n\nResponse Times (ms)\nAverage: \(.stats.avg // 0)\nP90: \(.stats.p90 // 0)\nP95: \(.stats.p95 // 0)\nP99: \(.stats.p99 // 0)\n\nFailure Rate: \(.failureRate // 0)%\nThroughput: \(.requestsPerSec // 0) requests/second"
              ' results.json
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "Load test results file not found"
            ls -la
            exit 1
          fi
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          COMMENT: ${{ steps.results.outputs.comment }}
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: process.env.COMMENT
            });
