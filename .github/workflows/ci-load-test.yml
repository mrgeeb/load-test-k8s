name: CI - Load Test on Kubernetes

on:
  pull_request:
    branches:
      - main

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup KinD cluster
        uses: helm/kind-action@v1.7.0
        with:
          cluster_name: load-test-cluster
          config: ./k8s/kind-config.yaml
      
      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Install Ingress controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/kind/deploy.yaml
          echo "Waiting for ingress-nginx namespace..."
          sleep 10
          
          # Wait for deployment to exist
          kubectl wait --for condition=established crd/ingressclasses.networking.k8s.io --timeout=30s || true
          
          echo "Patching ingress controller deployment..."
          # Delete the existing pod to force recreation with new tolerations
          kubectl delete pod -n ingress-nginx -l app.kubernetes.io/component=controller --ignore-not-found=true
          
          # Patch to add proper tolerations for all taints
          kubectl patch deployment ingress-nginx-controller -n ingress-nginx --type merge -p '{
            "spec": {
              "template": {
                "spec": {
                  "tolerations": [
                    {"key": "node-role.kubernetes.io/control-plane", "operator": "Exists", "effect": "NoSchedule"},
                    {"key": "node-role.kubernetes.io/control-plane", "operator": "Exists", "effect": "NoExecute"},
                    {"key": "node.kubernetes.io/not-ready", "operator": "Exists", "effect": "NoExecute", "tolerationSeconds": 300},
                    {"key": "node.kubernetes.io/unreachable", "operator": "Exists", "effect": "NoExecute", "tolerationSeconds": 300}
                  ]
                }
              }
            }
          }' 2>&1 | grep -v "Warning" || true
          
          echo "Waiting for controller pod to be ready (this may take 2-3 minutes)..."
          kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=600s || (echo "Controller pod failed to start:" && kubectl describe pods -n ingress-nginx && kubectl logs -n ingress-nginx -l app.kubernetes.io/component=controller --tail=50 && exit 1)
      
      - name: Deploy foo and bar services
        run: |
          kubectl apply -f ./k8s/namespace.yaml
          kubectl apply -f ./k8s/foo-deployment.yaml
          kubectl apply -f ./k8s/bar-deployment.yaml
          kubectl apply -f ./k8s/ingress.yaml
          # Wait for ingress to be ready
          kubectl wait --for=condition=ready ingress/app-ingress -n app --timeout=60s 2>/dev/null || true
      
      - name: Wait for deployments to be ready
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/foo -n app
          kubectl wait --for=condition=available --timeout=300s deployment/bar -n app
          kubectl get deployment,pods,svc,ingress -n app
      
      - name: Setup local DNS resolution
        run: |
          echo "127.0.0.1 foo.localhost" | sudo tee -a /etc/hosts
          echo "127.0.0.1 bar.localhost" | sudo tee -a /etc/hosts
      
      - name: Port-forward Ingress
        run: |
          kubectl port-forward -n ingress-nginx svc/ingress-nginx-controller 8080:80 &
          echo "INGRESS_PID=$!" >> $GITHUB_ENV
          sleep 5
      
      - name: Health check
        run: |
          bash ./scripts/health-check.sh
      
      - name: Run load test
        run: |
          bash ./scripts/load-test.sh
        env:
          LOAD_TEST_DURATION: 60
          LOAD_TEST_CONCURRENCY: 10
      
      - name: Get load test results
        if: always()
        run: |
          if [ -f load-test-results.json ]; then
            cat load-test-results.json > results.json
            cat load-test-results.txt
          else
            echo "‚ùå Load test results file not found"
            ls -la
            exit 1
          fi
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const results = JSON.parse(fs.readFileSync('results.json', 'utf8'));
              
              const comment = `## üìä Load Testing Results
              
              ### Summary
              - **Total Requests**: ${results.totalRequests}
              - **Successful Requests**: ${results.successfulRequests}
              - **Failed Requests**: ${results.failedRequests}
              - **Failure Rate**: ${results.failureRate}%
              - **Requests/sec**: ${results.requestsPerSec.toFixed(2)}
              
              ### Response Time Statistics (ms)
              - **Average**: ${results.stats.avg.toFixed(2)}
              - **Min**: ${results.stats.min.toFixed(2)}
              - **Max**: ${results.stats.max.toFixed(2)}
              - **P50**: ${results.stats.p50.toFixed(2)}
              - **P90**: ${results.stats.p90.toFixed(2)}
              - **P95**: ${results.stats.p95.toFixed(2)}
              - **P99**: ${results.stats.p99.toFixed(2)}
              
              ### Endpoint Breakdown
              ${results.endpoints.map(ep => `- **${ep.host}**: ${ep.successCount} passed, ${ep.failureCount} failed (avg: ${ep.avgResponseTime.toFixed(2)}ms)`).join('\n')}
              
              *Load test run completed at ${new Date().toISOString()}*
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.error('Error posting comment:', error);
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚ùå Load test failed. Check workflow logs for details.`
              });
            }